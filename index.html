<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 引入Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入Font Awesome图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- 引入Supabase客户端库 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="icon" href="favicon.ico">
    <meta name="description" content="北京八中少26B网站">
    <meta name="keywords" content="北京八中, 少26B, 少儿班">
    <title>少26B</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    
<!-- Intro / Loading Screen -->
<div id="intro-screen">
    <div class="intro-icon">
        <div class="icon-morph">
            <img src="bjbz_icon.webp" class="icon icon-school" alt="校徽">
            <img src="shao26b_icon.jpg" class="icon icon-class" alt="班徽">
        </div>
        <p class="intro-hint">点击进入班级主页</p>
    </div>
</div>


    <!-- 页面标题部分 - 与原网站完全一致 -->
    <header class="page-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    <div class="d-flex justify-content-center">
                        <div class="icon-circle me-2">
                            <img src="bjbz_icon.webp" alt="北京八中校徽">
                        </div>
                        <div class="icon-circle ms-2">
                            <img src="shao26b_icon.jpg" alt="少26B班徽">
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <h1 class="display-4 mb-2">
                        <a href="https://www.no8ms.bj.cn/cms/home/"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="school-link">
                            <span class="school-name">北京八中</span>
                        </a>
                        <span class="class-name">少26B班</span>
                    </h1>

                </div>
                <div class="col-md-2 text-end">
                    <a href="#" class="contact-btn" onclick="switchPage('contact')">
                        <i class="fas fa-envelope contact-icon"></i>
                        <span class="contact-text">联系我们</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- 黄色导航栏 - 与原网站完全一致，只修改了onclick -->
    <nav class="navbar navbar-expand-lg navbar-light custom-navbar sticky-top">
        <div class="container">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="ms-3">
    		<button id="themeToggle" class="btn btn-outline-secondary btn-sm">
        		<i id="themeIcon" class="fas fa-circle-half-stroke"></i>
    		</button>
	    </div>

            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link nav-custom-btn active" href="#" onclick="switchPage('homepage')" data-page="homepage">
                            <i class="fas fa-home me-2"></i>首页
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-custom-btn" href="#" onclick="switchPage('introduction')" data-page="introduction">
                            <i class="fas fa-users me-2"></i>师生介绍
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-custom-btn" href="#" onclick="switchPage('activities')" data-page="activities">
                            <i class="fas fa-images me-2"></i>活动相册
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-custom-btn" href="#" onclick="switchPage('journal')" data-page="journal">
                            <i class="fas fa-envelope me-2"></i>班级日志
                        </a>
                    </li>
                    <!-- 新增的“班级墙”导航项 -->
                    <li class="nav-item">
                        <a class="nav-link nav-custom-btn" href="#" onclick="switchPage('wall')" data-page="wall">
                            <i class="fas fa-pen-square me-2"></i>班级墙
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 动态内容区域 - 这里放置所有页面的内容 -->
    <main class="container my-5">
        <!-- 首页内容 - 保持原内容 -->
        <div id="homepage" class="page-content active">
            <div class="text-center">
                <h2 class="mb-4">欢迎来到少26B班网站</h2>
                <p class="lead">这里是北京八中少26B班网站，记录我们的学习、生活和成长点滴。</p>
                
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    网站正在建设中，敬请期待。
                </div>
                
                <!-- 简单的功能卡片 -->
                <div class="row mt-5">
                    <div class="col-md-3 mb-3">
                        <div class="card border-info h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-users fa-3x text-info mb-3"></i>
                                <h5 class="card-title">班级介绍</h5>
                                <p class="card-text">展示少26B班的特色和风采</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-warning h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-chalkboard-teacher fa-3x text-warning mb-3"></i>
                                <h5 class="card-title">教师介绍</h5>
                                <p class="card-text">认识我们的优秀教师团队</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-success h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-camera fa-3x text-success mb-3"></i>
                                <h5 class="card-title">活动记录</h5>
                                <p class="card-text">记录精彩的班级活动瞬间</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-danger h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-book-open fa-3x text-danger mb-3"></i>
                                <h5 class="card-title">班级日志</h5>
                                <p class="card-text">分享日常学习和生活点滴</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 师生介绍内容 - 保持原内容 -->
        <div id="introduction" class="page-content">
            <div class="text-center">            
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    网站正在建设中，敬请期待。
                </div>
            </div>
        </div>

        <!-- 活动相册内容 - 保持原内容 -->
        <div id="activities" class="page-content">
            <div class="text-center">            
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    网站正在建设中，敬请期待。
                </div>
            </div>
        </div>

        <!-- 班级日志内容 - 保持原内容 -->
        <div id="journal" class="page-content">
            <div class="text-center">            
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    网站正在建设中，敬请期待。
                </div>
            </div>
        </div>



        <!-- 修改班级墙部分，在帖子列表容器中添加一个示例卡片 -->
        <div id="wall" class="page-content">
            <div class="container">
                <div class="text-center mb-5">
                    <h2 class="mb-3"><i class="fas fa-pen-square me-2"></i>班级墙</h2>
                    <p class="text-muted">这里是少26B班的留言墙，记录我们的点滴和回忆</p>
                </div>
                
                <!-- 加载状态 -->
                <div id="wall-loading" class="text-center my-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-3">正在加载帖子...</p>
                </div>
                
                <!-- 错误提示 -->
                <div id="wall-error" class="alert alert-danger d-none text-center" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="error-message">加载失败，请稍后重试</span>
                </div>
                
                <!-- 帖子列表容器 -->
                <div id="posts-container" class="row g-4">
                    <!-- 帖子会通过JavaScript动态插入到这里 -->
                </div>
                
                <!-- 空状态 -->
                <div id="wall-empty" class="text-center my-5 d-none">
                    <div class="empty-state py-5">
                        <i class="fas fa-comment-slash fa-4x text-muted mb-4"></i>
                        <h4 class="text-muted mb-3">暂无帖子</h4>
                        <p class="text-muted">还没有人发帖，快来分享你的想法吧！</p>
                    </div>
                </div>
            </div>
        </div>


        
        <!-- 联系我们内容 - 保持原内容 -->
        <div id="contact" class="page-content">
            <div class="text-center">            
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    网站正在建设中，敬请期待。
                </div>
                <!-- 新增联系邮箱部分 -->
                <div class="contact-email mt-4 p-3 bg-light rounded">
                    <h5 class="mb-3">如有疑问请联系：</h5>
                    <div class="d-inline-block">
                        <a href="mailto:lilinfeng200801@gmail.com" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-envelope me-2"></i>lilinfeng200801@gmail.com
                        </a>
                    </div>
                    <p class="text-muted mt-2">点击邮箱地址可直接发送邮件</p>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 - 与原网站完全一致 -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>北京八中少26B班</h5>
                    <p>2019-2024</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p>&copy; 2026 北京八中少26B班 版权所有</p>
                    <p>网站维护：李林峰</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle (包含Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>

const LONG_PRESS_TIME = 3000;
let longPressTimer = null;
let glitchActive = false;

function triggerGlitch() {
    if (!glitchActive) {
        document.body.classList.add('glitch-mode');
        glitchActive = true;
        console.log('Glitch mode activated!');
    }
}

function resetGlitch() {
    if (glitchActive) {
        document.body.classList.remove('glitch-mode');
        glitchActive = false;
        console.log('Glitch mode deactivated!');
    }
}

// 鼠标长按
document.body.addEventListener('mousedown', (e) => {
    if (e.target === document.body) longPressTimer = setTimeout(triggerGlitch, LONG_PRESS_TIME);
});
document.body.addEventListener('mouseup', () => clearTimeout(longPressTimer));

// 触摸长按
document.body.addEventListener('touchstart', (e) => {
    if (e.target === document.body) longPressTimer = setTimeout(triggerGlitch, LONG_PRESS_TIME);
});
document.body.addEventListener('touchend', () => clearTimeout(longPressTimer));

// 双击退出
document.body.addEventListener('dblclick', resetGlitch);

(function () {
    const intro = document.getElementById('intro-screen');
    const schoolIcon = document.querySelector('#intro-screen .icon-school');
    const classIcon = document.querySelector('#intro-screen .icon-class');

    if (!intro || !schoolIcon || !classIcon) return;

    // 锁定页面滚动
    document.body.style.overflow = 'hidden';

    // 鼠标横向渐变
    intro.addEventListener('mousemove', (e) => {
        const width = window.innerWidth;
        const progress = Math.min(Math.max(e.clientX / width, 0), 1);
        schoolIcon.style.opacity = 1 - progress;
        classIcon.style.opacity = progress;
    });

    let entered = false;

    function enterSite() {
        if (entered) return;
        entered = true;

        intro.classList.add('fade-out');

        // 恢复页面滚动
        document.body.style.overflow = '';

        // 完全移除 intro
        setTimeout(() => {
            intro.remove();
        }, 600);
    }

    // 任意键 / 点击 / 触摸进入
    window.addEventListener('keydown', enterSite, { once: true });
    intro.addEventListener('click', enterSite, { once: true });
    intro.addEventListener('touchstart', enterSite, { once: true });
})();


    const root = document.documentElement;
    const toggleBtn = document.getElementById('themeToggle');
    const icon = document.getElementById('themeIcon');

    const THEMES = ['light', 'dark', 'system'];

    /* 应用主题 */
    function applyTheme(theme) {
        if (theme === 'system') {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            root.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        } else {
            root.setAttribute('data-theme', theme);
        }
        updateIcon(theme);
    }

    /* 更新图标 */
    function updateIcon(theme) {
        icon.className = 'fas ' + (
            theme === 'light' ? 'fa-sun' :
            theme === 'dark' ? 'fa-moon' :
            'fa-circle-half-stroke'
        );
    }

    /* 初始化 */
    let currentTheme = localStorage.getItem('theme') || 'system';
    applyTheme(currentTheme);

    /* 点击切换 */
    toggleBtn.addEventListener('click', () => {
        const index = THEMES.indexOf(currentTheme);
        currentTheme = THEMES[(index + 1) % THEMES.length];
        localStorage.setItem('theme', currentTheme);
        applyTheme(currentTheme);
    });

    /* 监听系统主题变化（仅 system 模式） */
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        if (currentTheme === 'system') {
            applyTheme('system');
        }
    });

        // Supabase配置常量（可以先定义）
        const SUPABASE_URL = 'https://frvlwqxbnpzwkvrawewe.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_k5rFSf8btQn8u6WLNAUgDQ_APxRcQFi';
        
        // 修复后的页面切换函数
        function switchPage(pageId, event) {
            if (event) {
                event.preventDefault(); // 阻止链接默认行为
                event.stopPropagation(); // 阻止事件冒泡
            }
            
            console.log('切换到页面:', pageId); // 调试用
            
            // 隐藏所有页面内容
            const allPages = document.querySelectorAll('.page-content');
            allPages.forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示目标页面
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                
                // ✅ 新增：如果是班级墙页面，加载帖子
                if (pageId === 'wall') {
                    console.log('切换到班级墙，开始加载帖子...');
                    // 使用setTimeout确保DOM更新完成
                    setTimeout(() => {
                        loadWallPosts();
                    }, 100);
                }

                // 如果是联系页面，滚动到顶部
                if (pageId === 'contact') {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } else {
                console.error('找不到页面:', pageId);
                // 如果找不到页面，默认显示首页
                document.getElementById('homepage').classList.add('active');
            }
            
            // 更新导航栏激活状态
            updateNavActiveState(pageId);
            
            // 更新浏览器URL（不刷新页面）
            try {
                window.history.pushState({page: pageId}, '', `#${pageId}`);
            } catch (e) {
                console.log('URL更新失败:', e);
            }
            
            return false; // 确保阻止默认行为
        }
        
        // 更新导航栏激活状态
        function updateNavActiveState(pageId) {
            // 移除所有导航按钮的active类
            const navButtons = document.querySelectorAll('.nav-custom-btn');
            navButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // 使用数据属性找到对应按钮
            const targetButton = document.querySelector(`.nav-custom-btn[data-page="${pageId}"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
        }
        
        // 创建单个帖子卡片的函数
        function createPostCard(post) {
            // 格式化日期
            const date = new Date(post.created_at);
            const formattedDate = date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // 获取作者姓名的第一个字作为头像显示
            const authorName = post.author_name || '匿名';
            const avatarText = authorName.charAt(0);
            
            // 创建卡片HTML
            const cardHtml = `
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="post-card">
                        <!-- 作者信息行 -->
                        <div class="post-author-info d-flex align-items-center mb-3">
                            <!-- 作者头像 -->
                            <div class="post-author-avatar me-3">
                                <div class="avatar-circle">
                                    <span class="avatar-text">${avatarText}</span>
                                </div>
                            </div>
                            <!-- 作者姓名和发布时间 -->
                            <div class="post-author-meta flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="post-author-name">${escapeHtml(authorName)}</span>
                                    <span class="post-date text-muted small">${formattedDate}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 帖子标题 -->
                        <h5 class="post-title fw-bold mb-2">${escapeHtml(post.title || '无标题')}</h5>
                        
                        <!-- 帖子内容 -->
                        <div class="post-content mb-3">
                            ${escapeHtml(post.content || '')}
                        </div>
                        
                        <!-- 底部信息（点赞数） -->
                        <div class="post-footer d-flex justify-content-end">
                            <div class="post-likes">
                                <i class="fas fa-heart me-1"></i>
                                <span class="likes-count">${post.likes || 0}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return cardHtml;
        }

        // 加载班级墙帖子的函数
        async function loadWallPosts() {
            console.log('开始加载帖子...');
            
            // 获取必要的DOM元素
            const loadingEl = document.getElementById('wall-loading');
            const errorEl = document.getElementById('wall-error');
            const emptyEl = document.getElementById('wall-empty');
            const containerEl = document.getElementById('posts-container');
            
            // 检查元素是否存在
            if (!loadingEl || !containerEl) {
                console.error('找不到必要的DOM元素');
                return;
            }
            
            try {
                // 显示加载状态
                loadingEl.style.display = 'block';
                if (errorEl) errorEl.classList.add('d-none');
                if (emptyEl) emptyEl.classList.add('d-none');
                containerEl.innerHTML = '';
                
                // 检查Supabase客户端是否已初始化
                if (!window.supabaseClient) {
                    throw new Error('Supabase客户端未初始化');
                }
                
                console.log('正在从Supabase获取帖子数据...');
                
                // 从Supabase获取数据
                // 按创建时间倒序排列，最新的在前面
                const { data: posts, error } = await window.supabaseClient
                    .from('posts')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                
                console.log('获取到帖子数据:', posts);
                
                // 隐藏加载状态
                loadingEl.style.display = 'none';
                
                // 检查是否有数据
                if (!posts || posts.length === 0) {
                    console.log('没有找到帖子');
                    if (emptyEl) {
                        emptyEl.classList.remove('d-none');
                    }
                    return;
                }
                
                console.log(`找到 ${posts.length} 个帖子`);
                
                // 清空容器（移除示例卡片）
                containerEl.innerHTML = '';
                
                // 遍历每个帖子并创建卡片
                posts.forEach(post => {
                    const cardHtml = createPostCard(post);
                    containerEl.innerHTML += cardHtml;
                });
                
            } catch (error) {
                console.error('加载帖子失败:', error);
                
                // 隐藏加载状态
                if (loadingEl) loadingEl.style.display = 'none';
                
                // 显示错误信息
                if (errorEl) {
                    const errorMessage = error.message || '加载失败，请稍后重试';
                    document.getElementById('error-message').textContent = errorMessage;
                    errorEl.classList.remove('d-none');
                }
            }
        }

        // HTML转义函数（防止XSS攻击）
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 页面加载时根据URL哈希显示对应页面
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成');
            
            // 只有在Supabase库加载完成后才创建客户端
            if (window.supabase && window.supabase.createClient) {
                // 创建Supabase客户端
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('Supabase客户端创建成功');
                
                // 可以把supabase对象保存到全局，供其他函数使用
                window.supabaseClient = supabase;
            } else {
                console.warn('Supabase库尚未加载完成，稍后重试');
            }
            
            // 获取URL中的哈希值（如 #homepage）
            const hash = window.location.hash.substring(1);
            
            // 如果有哈希值且对应的页面存在，则显示该页面
            if (hash && document.getElementById(hash)) {
                switchPage(hash);
                // ✅ 新增：如果直接访问班级墙，也要加载帖子
                if (hash === 'wall') {
                    // 确保页面切换完成后再加载
                    setTimeout(() => {
                        loadWallPosts();
                    }, 200);
                }
            } else {
                // 否则显示首页
                switchPage('homepage');
            }
            
            // 监听浏览器前进/后退按钮
            window.addEventListener('popstate', function(event) {
                const page = event.state ? event.state.page : 'homepage';
                switchPage(page);
            });
            
            // 确保所有导航链接都有正确的事件处理
            document.querySelectorAll('.nav-custom-btn, .contact-btn').forEach(link => {
                link.addEventListener('click', function(e) {
                    const page = this.getAttribute('data-page') || 
                                (this.classList.contains('contact-btn') ? 'contact' : 'homepage');
                    switchPage(page, e);
                });
            });
        });
    </script>
</body>
</html>
